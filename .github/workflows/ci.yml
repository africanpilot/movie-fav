name: CI/CD Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  test-microservices:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [account, links, monxt, movie, notifications, person, shows]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run microservice tests
        env:
          CICD_MODE: "True"
        run: |
          set -e  # Exit on any command failure
          chmod +x ./run.sh
          ./run.sh docker test up ${{ matrix.service }}

      - name: Cleanup
        if: always()
        run: |
          ./run.sh docker test down
          docker system prune -f

  # security-scan:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Run Trivy vulnerability scanner
  #       uses: aquasecurity/trivy-action@master
  #       with:
  #         scan-type: "fs"
  #         scan-ref: "."
  #         format: "sarif"
  #         output: "trivy-results.sarif"

  #     - name: Upload Trivy scan results to GitHub Security tab
  #       uses: github/codeql-action/upload-sarif@v3
  #       if: always()
  #       with:
  #         sarif_file: "trivy-results.sarif"

  # dependency-review:
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'pull_request'

  #   steps:
  #     - name: Dependency Review
  #       uses: actions/dependency-review-action@v4
